<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>LEAP è‹±å˜èªãƒ†ã‚¹ãƒˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
        ======================================== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #0f172a;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 1rem; 
        }

        /* ========================================
           ãƒ˜ãƒƒãƒ€ãƒ¼
        ======================================== */
        .header {
            text-align: center;
            padding: 2.5rem 1rem 2rem;
            color: white;
        }
        
        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: -0.05em;
            font-style: italic;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .header-line {
            width: 4rem;
            height: 0.3rem;
            background: #10b981;
            margin: 0.75rem auto;
            border-radius: 3px;
        }
        
        .header-subtitle {
            font-size: 0.7rem;
            letter-spacing: 0.5em;
            text-transform: uppercase;
            color: #34d399;
            font-weight: 700;
        }

        /* ========================================
           ã‚«ãƒ¼ãƒ‰ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        ======================================== */
        .card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #94a3b8;
            font-weight: 900;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
        }

        /* ========================================
           å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        ======================================== */
        .input-group { 
            margin-bottom: 1.25rem; 
        }
        
        .input-group label {
            display: block;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .input-pill {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 1.125rem;
            font-size: 1.75rem;
            font-weight: 900;
            font-family: 'Montserrat', sans-serif;
            background: #f8fafc;
            transition: all 0.3s;
            outline: none;
            text-align: center;
        }
        
        .input-pill:focus {
            border-color: #10b981;
            background: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* ========================================
           ã‚¹ã‚¤ãƒƒãƒ
        ======================================== */
        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.125rem;
            background: #f8fafc;
            border-radius: 1.125rem;
            border: 2px solid #f1f5f9;
            margin-bottom: 0.875rem;
            transition: all 0.2s;
        }
        
        .switch-row:active { 
            transform: scale(0.98); 
        }
        
        .switch-label {
            font-size: 0.95rem;
            font-weight: 700;
            color: #334155;
        }
        
        .switch {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider { 
            background-color: #10b981; 
        }
        
        input:checked + .slider:before { 
            transform: translateX(24px); 
        }

        /* ========================================
           ãƒœã‚¿ãƒ³
        ======================================== */
        .btn-primary {
            width: 100%;
            padding: 1.25rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 1.125rem;
            font-size: 1.05rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:active { 
            transform: scale(0.97); 
        }
        
        .home-btn {
            position: fixed;
            top: 1.25rem;
            left: 1.25rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 1.125rem;
            font-weight: 900;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .home-btn:active { 
            transform: scale(0.95); 
        }

        /* ========================================
           å•é¡Œè¡¨ç¤º
        ======================================== */
        .question-card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
        }
        
        .progress-number {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: #0f172a;
        }
        
        .word-tag {
            background: #ecfdf5;
            color: #059669;
            padding: 0.625rem 1.125rem;
            border-radius: 0.875rem;
            font-size: 0.8rem;
            font-weight: 900;
            border: 2px solid #d1fae5;
        }
        
        .sentence-box {
            background: #0f172a;
            color: white;
            padding: 1.75rem;
            border-radius: 1.25rem;
            font-size: 1.2rem;
            font-weight: 700;
            line-height: 1.7;
            margin-bottom: 1.5rem;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border-top: 5px solid #10b981;
        }
        
        .translation-box {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 1.25rem;
            border: 2px solid #f1f5f9;
            margin-bottom: 1.5rem;
        }
        
        .translation-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 900;
            margin-bottom: 0.625rem;
            letter-spacing: 0.15em;
        }
        
        .translation-text {
            font-size: 1.4rem;
            font-weight: 900;
            color: #0f172a;
            letter-spacing: -0.025em;
            line-height: 1.5;
        }

        /* ========================================
           é¸æŠè‚¢
        ======================================== */
        .choices { 
            display: grid; 
            gap: 0.875rem; 
            margin-bottom: 1.5rem; 
        }
        
        .choice-btn {
            padding: 1.25rem;
            background: white;
            border: 2.5px solid #e2e8f0;
            border-radius: 1.125rem;
            font-size: 1.05rem;
            font-weight: 700;
            color: #0f172a;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .choice-btn:active { 
            transform: scale(0.97); 
        }
        
        .choice-btn.correct {
            background: #ecfdf5;
            border-color: #10b981;
            color: #047857;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .choice-btn.incorrect {
            background: #fff1f2;
            border-color: #f43f5e;
            color: #be123c;
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
        }

        /* ========================================
           ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        ======================================== */
        .feedback-area {
            margin-top: 1.75rem;
            padding-top: 1.75rem;
            border-top: 2px solid #f1f5f9;
        }
        
        .feedback-text {
            text-align: center;
            padding: 1.75rem;
            border-radius: 1.25rem;
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 1.75rem;
        }
        
        .feedback-text.correct {
            background: #ecfdf5;
            color: #047857;
            border: 3px solid #10b981;
        }
        
        .feedback-text.incorrect {
            background: #fff1f2;
            color: #be123c;
            border: 3px solid #f43f5e;
        }
        
        .feedback-detail {
            font-size: 0.8rem;
            text-transform: uppercase;
            opacity: 0.7;
            display: block;
            margin-bottom: 0.625rem;
            letter-spacing: 0.1em;
        }
        
        .btn-next {
            width: 100%;
            padding: 1.375rem;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 1.125rem;
            font-size: 1.05rem;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.05em;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.4);
        }
        
        .btn-next:active { 
            transform: scale(0.97); 
        }

        /* ========================================
           çµæœç”»é¢
        ======================================== */
        .result-screen {
            text-align: center;
            background: white;
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .result-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #10b981;
            font-weight: 900;
            letter-spacing: 0.5em;
            margin-bottom: 1.25rem;
        }
        
        .result-score {
            font-family: 'Montserrat', sans-serif;
            font-size: 5.5rem;
            font-weight: 900;
            color: #0f172a;
            letter-spacing: -0.05em;
            margin-bottom: 1.25rem;
        }
        
        .result-message {
            font-size: 1.2rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 2.5rem;
            line-height: 1.6;
        }

        /* ========================================
           ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        ======================================== */
        .hidden { 
            display: none !important; 
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .error {
            background: #fff1f2;
            color: #be123c;
            padding: 1.5rem;
            border-radius: 1rem;
            margin: 1rem 0;
            border: 2px solid #f43f5e;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆä¸­ã®ã¿è¡¨ç¤ºï¼‰ -->
    <button id="homeBtn" class="home-btn hidden" onclick="goHome()">
        <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
        </svg>
        HOME
    </button>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <h1>LEAP</h1>
        <div class="header-line"></div>
        <div class="header-subtitle">Vocab Test</div>
    </div>

    <div class="container">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loadingScreen" class="loading">
            ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <!-- è¨­å®šç”»é¢ -->
        <div id="setupScreen" class="card hidden">
            <div class="section-title">ç¯„å›²è¨­å®š</div>
            <div class="range-inputs">
                <div class="input-group">
                    <label>From</label>
                    <input type="number" id="rangeStart" class="input-pill" value="1101" min="1101" max="1299">
                </div>
                <div class="input-group">
                    <label>To</label>
                    <input type="number" id="rangeEnd" class="input-pill" value="1150" min="1101" max="1299">
                </div>
            </div>
            
            <div class="input-group">
                <label>å‡ºé¡Œæ•°</label>
                <input type="number" id="questionCount" class="input-pill" value="10" min="1" max="199">
            </div>

            <div class="section-title">è¨­å®š</div>
            <div class="switch-row">
                <span class="switch-label">ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</span>
                <label class="switch">
                    <input type="checkbox" id="randomOrder" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span class="switch-label">ä¸»è¦ãªä¾‹æ–‡ã®ã¿</span>
                <label class="switch">
                    <input type="checkbox" id="primaryOnly" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <button class="btn-primary" onclick="startTest()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆç”»é¢ -->
        <div id="testScreen" class="hidden">
            <div class="question-card">
                <div class="progress-bar">
                    <div class="progress-number" id="progressText">01</div>
                    <div class="word-tag" id="wordTag">No. ----</div>
                </div>

                <div class="sentence-box" id="sentenceBox"></div>

                <div class="translation-box">
                    <div class="translation-label">æ—¥æœ¬èªè¨³</div>
                    <div class="translation-text" id="translationText"></div>
                </div>

                <div class="choices" id="choicesArea"></div>

                <div id="feedbackArea" class="feedback-area hidden">
                    <div class="feedback-text" id="feedbackText"></div>
                    <button class="btn-next" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â†’</button>
                </div>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultScreen" class="hidden">
            <div class="result-screen">
                <div class="result-badge">Test Complete</div>
                <div class="result-score" id="resultScore">0/0</div>
                <div class="result-message" id="resultMessage"></div>
                <button class="btn-primary" onclick="goHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        
        // å˜èªãƒ‡ãƒ¼ã‚¿ï¼ˆJSONã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼‰
        let vocabData = [];
        
        // æ„å‘³ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œæ™‚ã®é¸æŠè‚¢ç”Ÿæˆã«ä½¿ç”¨ï¼‰
        const semanticGroups = [
            { name: "åŠ´åƒãƒ»è·æ¥­ãƒ»çµ„ç¹”ãƒ»ç«‹å ´", words: [1101,1102,1103,1104,1105,1106,1107,1108,1109] },
            { name: "åŸºç¤ãƒ»æ§‹æˆãƒ»çµ±ä¸€ãƒ»çµåˆ", words: [1110,1111,1112,1113,1114,1115] },
            { name: "çŠ¯ç½ªãƒ»æ³•ãƒ»æš´åŠ›ãƒ»è¢«å®³", words: [1116,1117,1118,1119,1120,1121,1122,1123,1124] },
            { name: "è»äº‹ãƒ»æˆ¦äº‰ãƒ»é˜²è¡›ãƒ»äº‰ã„", words: [1125,1126,1127,1128,1129,1130,1131] },
            { name: "ç½å®³ãƒ»å±é™ºãƒ»å¼±è€…", words: [1132,1133,1134,1135,1136] },
            { name: "äººãƒ»èº«åˆ†ãƒ»ç”Ÿæ´»", words: [1137,1138,1139,1140,1141] },
            { name: "è¿½è·¡ãƒ»ç§»å‹•ãƒ»å¤‰åŒ–", words: [1142,1143,1144,1145,1146,1147,1148,1149] },
            { name: "å¤‰åŒ–ãƒ»æ”¹è‰¯ãƒ»æ”¹é©", words: [1150,1151,1152,1153] },
            { name: "ç§»å‹•ãƒ»ç¢ºèªãƒ»å¯¾å¿œ", words: [1154,1155,1156,1157,1158,1159,1160,1161] },
            { name: "å¼·åˆ¶ãƒ»æ„Ÿæƒ…ãƒ»è¡Œå‹•", words: [1162,1163,1164,1165,1166,1167,1168,1169,1170,1171] },
            { name: "åå¿œãƒ»çµŒé¨“ãƒ»éç¨‹", words: [1172,1173,1174,1175,1176,1177,1178,1179,1180,1181,1182] },
            { name: "çŸ¥è­˜ãƒ»æ‰€æœ‰ãƒ»ä¿æŒ", words: [1183,1184,1185,1186] },
            { name: "æ•ç²ãƒ»èª¿æŸ»ãƒ»å°‚é–€", words: [1187,1188,1189,1190] },
            { name: "å­¦å•ãƒ»åˆ¶åº¦", words: [1191,1192,1193,1194,1195,1196,1197,1198,1199] },
            { name: "æ€è€ƒãƒ»æ…‹åº¦ãƒ»æ„å¿—", words: [1200,1201,1202,1203,1204,1205,1206,1207,1208,1209] },
            { name: "èªè­˜ãƒ»ç†è§£ãƒ»åˆ¤æ–­", words: [1210,1211,1212,1213,1214,1215,1216,1217] },
            { name: "è‡ªç„¶ãƒ»ç’°å¢ƒ", words: [1218,1219,1220,1221,1222,1223,1224,1225,1226,1227,1228,1229,1230,1231] },
            { name: "å‹•æ¤ç‰©ãƒ»ç”Ÿç‰©", words: [1232,1233,1234,1235,1236,1237,1238,1239,1240,1241,1242,1243,1244,1245,1246,1247] },
            { name: "æ€§æ ¼ãƒ»æ€§è³ª", words: [1248,1249,1250,1251,1252,1253] },
            { name: "é‡è¦æ€§ãƒ»è©•ä¾¡", words: [1254,1255,1256,1257,1258,1259,1260,1261] },
            { name: "å°è±¡ãƒ»æ„Ÿæƒ…", words: [1262,1263,1264,1265,1266,1267,1268,1269,1270,1271,1272,1273,1274,1275,1276] },
            { name: "å¤§ãã•ãƒ»å½¢ãƒ»æ€§è³ª", words: [1277,1278,1279,1280,1281,1282,1283,1284,1285,1286,1287,1288] },
            { name: "æ¡ä»¶ãƒ»ç¯„å›²ãƒ»æ¯”è¼ƒ", words: [1289,1290,1291,1292,1293,1294,1295,1296,1297,1298,1299] }
        ];
        
        // ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³
        let currentSession = {
            questions: [],      // å•é¡Œãƒªã‚¹ãƒˆ
            currentIndex: 0,    // ç¾åœ¨ã®å•é¡Œç•ªå·
            score: 0           // æ­£è§£æ•°
        };

        // éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§åˆæœŸåŒ–ï¼‰
        let audioCtx = null;

        // ========================================
        // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ 
        // ========================================
        
        /**
         * éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
         */
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        /**
         * ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿ
         */
        function playTap() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.08);
        }
        
        /**
         * æ­£è§£éŸ³ã‚’å†ç”Ÿ
         */
        function playCorrect() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }
        
        /**
         * ä¸æ­£è§£éŸ³ã‚’å†ç”Ÿ
         */
        function playIncorrect() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.35);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.35);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.35);
        }

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ========================================
        
        /**
         * words.jsonã‚’èª­ã¿è¾¼ã‚€
         */
        async function loadVocabData() {
            try {
                const response = await fetch('words.json');
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // JSONãƒ‘ãƒ¼ã‚¹
                const data = await response.json();
                
                // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                }
                
                vocabData = data;
                console.log(`${vocabData.length}èªã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤ºã€è¨­å®šç”»é¢è¡¨ç¤º
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('setupScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.innerHTML = `
                    <div class="error">
                        <strong>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</strong><br>
                        ${error.message}<br><br>
                        <small>words.jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
                        ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯Webã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚</small>
                    </div>
                `;
            }
        }

        // ========================================
        // ãƒ†ã‚¹ãƒˆé–‹å§‹
        // ========================================
        
        /**
         * ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹
         */
        function startTest() {
            playTap();
            
            // è¨­å®šå€¤ã‚’å–å¾—
            const start = parseInt(document.getElementById('rangeStart').value);
            const end = parseInt(document.getElementById('rangeEnd').value);
            const count = parseInt(document.getElementById('questionCount').value);
            const isRandom = document.getElementById('randomOrder').checked;
            const primaryOnly = document.getElementById('primaryOnly').checked;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (start > end) {
                alert('ç¯„å›²ãŒä¸æ­£ã§ã™');
                return;
            }
            
            if (count < 1) {
                alert('å‡ºé¡Œæ•°ã¯1ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å•é¡Œã‚’ç”Ÿæˆ
            let questions = [];
            
            // æŒ‡å®šç¯„å›²ã®å˜èªã‚’å–å¾—
            const filteredWords = vocabData.filter(word => word.id >= start && word.id <= end);
            
            if (filteredWords.length === 0) {
                alert('æŒ‡å®šç¯„å›²ã«å˜èªãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // å„å˜èªã‹ã‚‰ä¾‹æ–‡ã‚’é¸æŠ
            filteredWords.forEach(wordData => {
                const examples = primaryOnly ? [wordData.examples[0]] : wordData.examples;
                
                examples.forEach(example => {
                    questions.push({
                        id: wordData.id,
                        word: wordData.word,
                        sentence: example.en,
                        translation: example.jp
                    });
                });
            });
            
            // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã®å ´åˆã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            if (isRandom) {
                questions.sort(() => Math.random() - 0.5);
            }
            
            // å‡ºé¡Œæ•°ã«åˆ¶é™
            questions = questions.slice(0, count);
            
            if (questions.length === 0) {
                alert('å‡ºé¡Œã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
            currentSession = {
                questions: questions,
                currentIndex: 0,
                score: 0
            };
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('testScreen').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
            
            // æœ€åˆã®å•é¡Œã‚’è¡¨ç¤º
            showQuestion();
        }

        // ========================================
        // å•é¡Œè¡¨ç¤º
        // ========================================
        
        /**
         * ç¾åœ¨ã®å•é¡Œã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showQuestion() {
            const question = currentSession.questions[currentSession.currentIndex];
            
            // é€²æ—è¡¨ç¤º
            const progressNum = currentSession.currentIndex + 1;
            document.getElementById('progressText').textContent = String(progressNum).padStart(2, '0');
            document.getElementById('wordTag').textContent = `No. ${question.id}`;
            
            // ä¾‹æ–‡è¡¨ç¤ºï¼ˆå˜èªéƒ¨åˆ†ã‚’ ( ? ) ã«ç½®ãæ›ãˆï¼‰
            const sentenceWithBlank = question.sentence.replace(
                new RegExp(`\\b${question.word}\\b`, 'gi'), 
                '( ? )'
            );
            document.getElementById('sentenceBox').textContent = sentenceWithBlank;
            
            // æ—¥æœ¬èªè¨³è¡¨ç¤º
            document.getElementById('translationText').textContent = question.translation;
            
            // é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const choices = generateChoices(question);
            
            // é¸æŠè‚¢ã‚’HTMLåŒ–
            const choicesArea = document.getElementById('choicesArea');
            choicesArea.innerHTML = '';
            
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice;
                btn.onclick = () => selectAnswer(choice, question.word, btn);
                choicesArea.appendChild(btn);
            });
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('feedbackArea').classList.add('hidden');
        }
        
        /**
         * é¸æŠè‚¢ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆæ­£è§£1ã¤ + ä¸æ­£è§£3ã¤ï¼‰
         * @param {Object} question - ç¾åœ¨ã®å•é¡Œ
         * @returns {Array} - ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸé¸æŠè‚¢é…åˆ—
         */
        function generateChoices(question) {
            const correctWord = question.word;
            
            // åŒã˜æ„å‘³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ä¸æ­£è§£ã®é¸æŠè‚¢ã‚’é¸ã¶
            let distractors = [];
            
            // ç¾åœ¨ã®å˜èªãŒå±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¦‹ã¤ã‘ã‚‹
            const currentGroup = semanticGroups.find(group => 
                group.words.includes(question.id)
            );
            
            if (currentGroup) {
                // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ä»–ã®å˜èªã‹ã‚‰é¸æŠ
                const groupWords = currentGroup.words
                    .filter(id => id !== question.id)
                    .map(id => vocabData.find(w => w.id === id))
                    .filter(w => w && w.word !== correctWord)
                    .map(w => w.word);
                
                // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                while (distractors.length < 3 && groupWords.length > 0) {
                    const randomIndex = Math.floor(Math.random() * groupWords.length);
                    const word = groupWords.splice(randomIndex, 1)[0];
                    if (!distractors.includes(word)) {
                        distractors.push(word);
                    }
                }
            }
            
            // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§è¶³ã‚Šãªã„å ´åˆã¯å…¨ä½“ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
            if (distractors.length < 3) {
                const allWords = vocabData
                    .filter(w => w.word !== correctWord && !distractors.includes(w.word))
                    .map(w => w.word);
                
                while (distractors.length < 3 && allWords.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allWords.length);
                    distractors.push(allWords.splice(randomIndex, 1)[0]);
                }
            }
            
            // æ­£è§£ã¨ä¸æ­£è§£ã‚’çµåˆã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const choices = [correctWord, ...distractors];
            return choices.sort(() => Math.random() - 0.5);
        }

        // ========================================
        // è§£ç­”å‡¦ç†
        // ========================================
        
        /**
         * é¸æŠè‚¢ãŒé¸ã°ã‚ŒãŸã¨ãã®å‡¦ç†
         * @param {string} selected - é¸æŠã•ã‚ŒãŸå˜èª
         * @param {string} correct - æ­£è§£ã®å˜èª
         * @param {HTMLElement} btn - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³è¦ç´ 
         */
        function selectAnswer(selected, correct, btn) {
            playTap();
            
            const isCorrect = selected === correct;
            
            // å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const allButtons = document.querySelectorAll('.choice-btn');
            allButtons.forEach(b => {
                b.style.pointerEvents = 'none';
                
                // æ­£è§£ã®ãƒœã‚¿ãƒ³ã«æ­£è§£ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                if (b.textContent === correct) {
                    b.classList.add('correct');
                }
                // ä¸æ­£è§£ã‚’é¸æŠã—ãŸå ´åˆã€ãã®ãƒœã‚¿ãƒ³ã«ä¸æ­£è§£ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                else if (b === btn && !isCorrect) {
                    b.classList.add('incorrect');
                }
            });
            
            // æ­£è§£/ä¸æ­£è§£ã®å‡¦ç†
            if (isCorrect) {
                playCorrect();
                currentSession.score++;
                document.getElementById('feedbackText').innerHTML = 'âœ“ æ­£è§£ï¼';
                document.getElementById('feedbackText').className = 'feedback-text correct';
            } else {
                playIncorrect();
                document.getElementById('feedbackText').innerHTML = 
                    `<span class="feedback-detail">æ­£è§£</span>${correct}`;
                document.getElementById('feedbackText').className = 'feedback-text incorrect';
            }
            
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            document.getElementById('feedbackArea').classList.remove('hidden');
        }

        // ========================================
        // æ¬¡ã®å•é¡Œã¸
        // ========================================
        
        /**
         * æ¬¡ã®å•é¡Œã‚’è¡¨ç¤ºï¼ˆã¾ãŸã¯çµæœç”»é¢ã¸é·ç§»ï¼‰
         */
        function nextQuestion() {
            playTap();
            
            currentSession.currentIndex++;
            
            // ã¾ã å•é¡ŒãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
            if (currentSession.currentIndex < currentSession.questions.length) {
                showQuestion();
            } 
            // å…¨å•é¡Œçµ‚äº†
            else {
                showResult();
            }
        }

        // ========================================
        // çµæœè¡¨ç¤º
        // ========================================
        
        /**
         * ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
         */
        function showResult() {
            const total = currentSession.questions.length;
            const score = currentSession.score;
            const percentage = Math.round((score / total) * 100);
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('testScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            document.getElementById('resultScore').textContent = `${score}/${total}`;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ±ºå®š
            let message = '';
            if (percentage >= 90) {
                message = 'ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ã§ã™ï¼ğŸ‰';
            } else if (percentage >= 70) {
                message = 'ã‚ˆãã§ãã¾ã—ãŸï¼ğŸ‘';
            } else if (percentage >= 50) {
                message = 'ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
            } else {
                message = 'å¾©ç¿’ãŒå¿…è¦ã§ã™ğŸ“š';
            }
            
            document.getElementById('resultMessage').textContent = message;
        }

        // ========================================
        // ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
        // ========================================
        
        /**
         * ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆè¨­å®šç”»é¢ï¼‰ã«æˆ»ã‚‹
         */
        function goHome() {
            playTap();
            location.reload();
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        window.addEventListener('DOMContentLoaded', () => {
            loadVocabData();
        });
        
        // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿ
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                playTap();
            }
        });
    </script>
</body>
</html>
